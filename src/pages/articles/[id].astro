---
import Base from '@/layouts/Base.astro';
import { fetchMeta, fetchNewsArticleById, fetchNewsRawByIds, fetchSources, fetchTags } from '@/lib/api';
import { formatDate, getSourceName, processArticleContent, cleanTitle, slugify } from '@/lib/utils';

export async function getStaticPaths() {
  // Fetch metadata to get latest cluster ID
  const meta = await fetchMeta();
  const latestId = meta.tables.news_articles.latest_id;

  // Generate static pages for last 100 clusters
  const staticLimit = 100;
  const paths = [];

  for (let id = latestId; id > latestId - staticLimit && id > 0; id--) {
    paths.push({
      params: { id: id.toString() },
    });
  }

  return paths;
}

const { id } = Astro.params;
const article = await fetchNewsArticleById(parseInt(id));

if (!article) {
  return Astro.redirect('/404');
}

const rawItems = await fetchNewsRawByIds(article.articles);

const [sources, allTags] = await Promise.all([fetchSources(), fetchTags()]);

const sourcesMap = new Map(sources.map((s) => [s.id, s]));
const clusterTags = allTags.filter((tag) => article.cats.includes(tag.id));

const processedShortDesc = article.short_desc ? processArticleContent(article.short_desc) : '';
---

<Base title={`${cleanTitle(article.title)} - News Cluster`} description={article.short_desc || cleanTitle(article.title)} headerVariant="minimal" includeFooter={false}>
  <meta slot="head" name="lastmod" content={article.created_at} />
  <script slot="head" type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": cleanTitle(article.title),
    "description": article.short_desc || cleanTitle(article.title),
    "datePublished": article.created_at,
    "dateModified": article.created_at,
    "url": `${new URL(import.meta.env.SITE || "https://newshelp.org").origin}/articles/${article.id}`,
    "numberOfItems": rawItems.length,
    "itemListElement": rawItems.slice(0, 10).map((item, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "item": {
        "@type": "NewsArticle",
        "headline": item.title,
        "url": `${new URL(import.meta.env.SITE || "https://newshelp.org").origin}/news/${item.id}`,
        "datePublished": item.created_at
      }
    }))
  })} />

  <article class="cluster-full">
    <header class="cluster-full__header">
      <h1 class="cluster-full__title">{cleanTitle(article.title)}</h1>

      {processedShortDesc && (
        <p class="cluster-full__description" set:html={processedShortDesc} />
      )}

      <time class="cluster-full__date" datetime={article.created_at}>
        {formatDate(article.created_at)}
      </time>

      <div class="cluster-full__meta">
        <span class="cluster-full__count">{rawItems.length} articles in this cluster</span>
      </div>

      {clusterTags.length > 0 && (
        <div class="cluster-full__tags">
          {clusterTags.map(
            (tag) => (
              <a href={`/tag/${slugify(tag.tag)}`} class="tag">
                {tag.tag}
              </a>
            )
          )}
        </div>
      )}
    </header>

    <div class="cluster-full__articles">
      <h2 class="cluster-full__section-title">Articles in this Cluster</h2>
      <div class="cluster-full__list">
        {rawItems.map((item) => (
          <a href={`/news/${item.id}`} class="cluster-article-card">
            {item.imgUrl && (
              <div class="cluster-article-card__image">
                <img src={item.imgUrl} alt={item.title} loading="lazy" />
              </div>
            )}
            <div class="cluster-article-card__content">
              <span class="cluster-article-card__source">{getSourceName(item.source, sourcesMap)}</span>
              <h3 class="cluster-article-card__title">{cleanTitle(item.title)}</h3>
              <time class="cluster-article-card__date" datetime={item.created_at}>
                {formatDate(item.created_at)}
              </time>
            </div>
          </a>
        ))}
      </div>
    </div>

    <footer class="cluster-full__footer">
      <a href="/">‚Üê Back to Home</a>
    </footer>
  </article>

  <script slot="main" type="module" src="/scripts/main.js"></script>
</Base>

<style>
  .cluster-full {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .cluster-full__header {
    margin-bottom: 3rem;
  }

  .cluster-full__title {
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1.2;
    margin-bottom: 1rem;
  }

  .cluster-full__description {
    font-size: 1.25rem;
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin-bottom: 1rem;
    white-space: pre-line;
  }

  .cluster-full__description :global(a) {
    color: var(--color-accent);
    text-decoration: none;
    font-weight: 600;
    background: var(--color-surface);
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  .cluster-full__description :global(a:hover) {
    background: var(--color-primary);
    color: white;
  }

  .cluster-full__date {
    display: block;
    color: var(--color-text-tertiary);
    font-size: 0.875rem;
    margin-bottom: 1rem;
  }

  .cluster-full__meta {
    margin-bottom: 1rem;
  }

  .cluster-full__count {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: var(--color-primary);
    color: white;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .cluster-full__tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .cluster-full__tags .tag {
    padding: 0.25rem 0.75rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 20px;
    font-size: 0.875rem;
    text-decoration: none;
    color: var(--color-text);
  }

  .cluster-full__section-title {
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--color-border);
  }

  .cluster-full__list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
  }

  .cluster-article-card {
    display: flex;
    flex-direction: column;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    overflow: hidden;
    text-decoration: none;
    color: var(--color-text);
    transition: all 0.2s;
  }

  .cluster-article-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--color-primary);
  }

  .cluster-article-card__image {
    aspect-ratio: 16 / 9;
    overflow: hidden;
  }

  .cluster-article-card__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .cluster-article-card__content {
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .cluster-article-card__source {
    font-size: 0.75rem;
    color: var(--color-accent);
    text-transform: uppercase;
    font-weight: 600;
  }

  .cluster-article-card__title {
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
    line-height: 1.4;
  }

  .cluster-article-card__date {
    font-size: 0.75rem;
    color: var(--color-text-tertiary);
  }

  .cluster-full__footer {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-surface);
  }

  .cluster-full__footer a {
    text-decoration: none;
    color: var(--color-text);
  }

  .cluster-full__footer a:hover {
    color: var(--color-primary);
  }

  @media (max-width: 768px) {
    .cluster-full__list {
      grid-template-columns: 1fr;
    }
  }
</style>
